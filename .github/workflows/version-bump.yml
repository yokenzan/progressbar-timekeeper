name: Version Bump

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version type to bump'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      
permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Get current version
      id: current_version
      run: |
        CURRENT_VERSION=$(grep -oP '(?<=<VersionPrefix>)[^<]+' Directory.Build.props)
        echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $CURRENT_VERSION"
        
    - name: Calculate new version
      id: new_version
      run: |
        CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
        VERSION_TYPE="${{ github.event.inputs.version_type }}"
        
        # Split version into components
        IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR="${VERSION_PARTS[0]}"
        MINOR="${VERSION_PARTS[1]}"
        PATCH="${VERSION_PARTS[2]}"
        
        # Increment based on version type
        case $VERSION_TYPE in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: $NEW_VERSION"
        
    - name: Update version in Directory.Build.props
      run: |
        sed -i "s/<VersionPrefix>.*<\/VersionPrefix>/<VersionPrefix>${{ steps.new_version.outputs.new_version }}<\/VersionPrefix>/" Directory.Build.props
        
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: bump version to ${{ steps.new_version.outputs.new_version }}"
        title: "chore: bump version to ${{ steps.new_version.outputs.new_version }}"
        body: |
          ## Version Bump
          
          This PR bumps the version from `${{ steps.current_version.outputs.current_version }}` to `${{ steps.new_version.outputs.new_version }}`.
          
          ### Type of change
          - ${{ github.event.inputs.version_type }} version bump
          
          ### Checklist
          - [ ] Version updated in Directory.Build.props
          - [ ] All builds pass
          - [ ] Ready to merge
          
          ### ðŸš€ What happens after merge?
          When this PR is merged to master, the auto-release workflow will:
          1. Detect the version change
          2. Build new binaries
          3. Create version tag (v${{ steps.new_version.outputs.new_version }})
          4. Create GitHub Release automatically
        branch: version-bump-${{ steps.new_version.outputs.new_version }}
        delete-branch: true
        labels: |
          version-bump
          automated